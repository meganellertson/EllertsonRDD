---
title: "RDD Replication 1"
author: "Megan Ellertson"
date: "2/14/2021"
output:
  pdf_document: default
  html_document: default
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r library set up}
library(readr)
library(tidyverse)
library(ggplot2)
library(readr)
library(dplyr)
library(tidyr)
library(rdd)
library(haven)
library(estimatr)
library(rdrobust)
library(rddensity)
library(cli)

```

Question 1
The data being used is pulled downloaded and installed from the local directory under "Data" labeled repository: "Ellertson RDD". This "RDD" is already an existing repository, therefore this assignment utilized a new repository with a slightly more specific title. The first item completed is the importing of the data being used. 
```{r }

raw_hansen_dwi <- read_csv("Data/hansen_dwi.csv")

```

Question 2 
**Summary**

Question 3
"Cutoff" is the label for the new binary variable generated around the 0.08 BAC level. 
```{r dummy variable creation}
RDDdata <- mutate(raw_hansen_dwi, cutoff = car::Recode(bac1, "lo: 0.08= 0; else = 1"))
head(RDDdata)


categories <- RDDdata$bac1 
demmeans <- split(RDDdata$recidivism, cut(RDDdata$bac1, 100)) %>%
  lapply(mean) %>%
  unlist()
agg_RDDdata <- data.frame(recidivism = demmeans, bac1 = seq(0.01, 0.5, by = 0.01))
plottingdata <- RDDdata %>%
  mutate(gg_group = case_when(bac1>= 0.08 ~ 1, TRUE ~ 0))

ggplot(plottingdata, aes(bac1, recidivism)) +
  geom_point(aes(x=bac1, y = recidivism), data = agg_RDDdata) +
  stat_smooth(aes(bac1, recidivism, group = gg_group), method = "lm",formula = y ~ x + I(x^2)) +
  xlim(0,0.2) + ylim(0,.25) +
  geom_vline(xintercept = 0.08)

ggplot(plottingdata, aes(bac1, recidivism)) +
  geom_point(aes(x=bac1, y = recidivism), data = agg_RDDdata) +
  stat_smooth(aes(bac1, recidivism, group = gg_group), method = "lm") +
  geom_vline(xintercept = 0.08)
  
``` 
Question 4 
To check to see if there is evidence for manipulation or sorting on the running variable "bac1" we want to examine the behavior of the data around the cutoffs of interest.  We want to assess to see if there is any ability of the individuals in the data set to control if they are at the 0.08 BAC or at DUI level. We want to ensure that there is no ability for the participants to "choose" the treatment. We would assume that this would not necessarily be possible given it is difficult to determine while drinking your level of BAC and many individuals have difficulty controlling their alcohol consumption. However, we must examine the data through the density functions created by Hansen or through the McCrary Density test.  There are a few options of replicating this below.
First it is important to examine the summary statistics to understand what the data is that you are examining. 

```{r mylatextable, results = "asis"}
stargazer(RDDdata, type = 'latex')

```



```{r}
figure1 <- ggplot(RDDdata, aes(bac1)) +
  geom_histogram(binwidth = 0.001, color = "grey", fill = "white") 
figure1 + geom_vline(aes(xintercept = 0.08), color = "black", size = 1) +
  geom_vline(aes(xintercept = 0.15), color = "black", size = 1) +
  labs(title = "BAC Histogram", x = "bac1", y = "Frequency")
```


From all three of these options, it is clear that the data does not present any form of manipulation. In the first example, the McCrary Density test outputted a p-value extremely low and statistically significant indicating that there is no evidence of this manipulation.  We want to ensure that the treatment effect is the only change which is occurring, that is randomly assigned, not chosen by individuals. CONTINUE
```{r}

DCdensity(RDDdata$bac1, cutpoint = 0.08)

density <- rddensity(RDDdata$bac1, c = 0.08)
rdplotdensity(density, RDDdata$bac1)
```

Question 5 potential option thismay need to be bac1 ~ the covariates?
```{r} 
RDDdata5 <- RDDdata %>%
  filter(bac1 >= 0.08)
reg1 <- lm_robust(recidivism ~ male, data = RDDdata5)
reg2 <- lm_robust(recidivism ~ aged, data = RDDdata5)
reg3 <- lm_robust(recidivism ~ acc, data = RDDdata5)
reg4 <- lm_robust(recidivism ~ white, data = RDDdata5)

malechar <- lm_robust(cutoff ~ bac1 + male, data = RDDdata)
summary(malechar)
agechar <- lm_robust(cutoff ~ bac1 + aged, data = RDDdata)
summary(agechar) 
accchar <- lm-robust(cutoff ~ bac1 + )

stargazer(reg1, reg2, reg3, reg4, title="Table 2 - Regression Discontinuity Estimates for the Effect of Exceeding BAC Thresholds on Predetermined Characteristics", align = TRUE, dep.var.labels =c("male", "age", "acc", "white"), no.space=TRUE)

or

cli::cli_text("Table 2: Regression Discontinuity Estimates for the Effect of Exceeding BAC Thresholds on Predetermined Characteristics")
texreg::screenreg(list(reg1, reg2, reg3, reg4), type="text")


```


Question 6
```{r echo = FALSE}
cli::cli_text("testing")
ggplot(data = RDDdata) +
geom_point(alpha = 0.5) +
geom_vline(xintercept = 0.8, color = "black", linetype = 1)+


```


Question 7
```{r}

RDDdata_subset1 <- RDDdata %>% 
  filter(bac1>0.03 & bac1 < 0.13)

lm_1 <- lm_robust(recidivism ~ bac1, data = RDDdata_subset1)
lm_2 <- lm_robust(recidivism ~ bac1*cutoff, data = RDDdata_subset1)
RDDdata_subset1a <- RDDdata_subset1 %>%
  mutate(bac1sq = bac1^2)
lm_3 <- lm_robust(recidivism ~ bac1*cutoff + bac1sq*cutoff, data = RDDdata_subset1a)

summary(lm_1)
summary(lm_2)
summary(lm_3)

## Panel B 
RDDdata_subset2 <- RDDdata %>% 
  filter(bac1>0.055 & bac1 < 0.105)

lm_4 <- lm_robust(recidivism ~ bac1, data = RDDdata_subset2)
lm_5 <- lm_robust(recidivism ~ bac1 + cutoff + bac1*cutoff, data = RDDdata_subset2)
RDDdata_subset2a <- RDDdata_subset2 %>%
  mutate(bac1sq = bac1^2)
lm_6 <- lm_robust(recidivism ~ bac1*cutoff + bac1sq*cutoff, data = RDDdata_subset2a)

summary(lm_4)
summary(lm_5)
summary(lm_6)

cli::cli_text("Table 3")
texreg::screenreg(list(lm_1, lm_2, lm_3, lm_4, lm_5, lm_6), type="text")

```


Question 8
```{r}


```


Question 9

```{r}

```


